// composer@0.13.0 downloaded from https://ga.jspm.io/npm:composer@0.13.0/index.js

import t from"lazy-cache";import r from"array-unique";import n from"bach";import e from"co";import i from"define-property";import o from"extend-shallow";import s from"isobject";import a from"is-generator";import p from"is-glob";import f from"micromatch";import u from"nanoseconds";import h from"process";import c from"component-emitter";import l from"util";var m={};var v=t(null);var d=null;require=v;r;n;e;i;o;s;a;p;f;u;require=d;v.arrayify=function(t){return t?Array.isArray(t)?t:[t]:[]};m=v;var y=m;var g={};var k=h;var b=y;function Run(t){if(!(this instanceof Run))return new Run(t);this.runId=t;this.date={};this.hr={};Object.defineProperty(this.hr,"diff",{get:function(){return b.nano(this.end)-b.nano(this.start)}});Object.defineProperty(this.hr,"offset",{get:function(){return b.nano(this.duration)-this.diff}})}Run.prototype.start=function(){this.date.start=new Date;this.hr.start=k.hrtime()};Run.prototype.end=function(){this.hr.end=k.hrtime();this.hr.duration=k.hrtime(this.hr.start);this.date.end=new Date};g=Run;var w=g;var T={};var j=y;T=function(t){var r=t.length,n=0;var e=[];var i={};if(r&&j.isobject(t[r-1])){i=t.pop();r--}while(r--){var o=t[n++];if(isGlob(o)){var s=j.mm.matchKeys(this.tasks,o);var a=Object.keys(s);if(!a.length)throw new Error('glob pattern "'+o+'" did not match any tasks');for(var p=0;p<a.length;p++)e.push(getTaskFn(this.tasks,a[p],i))}else{"string"===typeof o&&(o=getTaskFn(this.tasks,o,i));e.push(o)}}return e};var E=/\[anonymous \(\d*\)\]/;function isGlob(t){return j.isGlob(t)&&!E.test(t)}function getTaskFn(t,r,n){var e=t[r];if(!e)throw new Error('task "'+r+'" is not registered');j.extend(e.options,n);return e.run.bind(e)}var R=T;var x={};var F=y;var C=R;function flowFactory(t){return function(){var r=[].concat.apply([],[].slice.call(arguments));var n=this;return function(e){"function"!==typeof e&&(e=function(t){t&&n.emit("error",t)});var i;try{i=C.call(n,r)}catch(t){return e(t)}if(1===i.length)return i[0](e);var o;try{o=F.bach[t].apply(F.bach,i)}catch(t){return e(t)}return o(e)}}}x=flowFactory;var _=x;var q={};q=function(t){return t()};var D=q;var G={};var O=c;var A=_;var B=y;var P=D;var z=w;function Task(t){if(!(this instanceof Task))return new Task(t);O.call(this);if("undefined"===typeof t)throw new Error("Expected `task` to be an `object` but got `"+typeof t+"`.");if("undefined"===typeof t.name)throw new Error("Expected `task.name` to be a `string` but got `"+typeof t.name+"`.");this.app=t.app;this.name=t.name;this.options=t.options||{};this.deps=t.deps||this.options.deps||[];this.fn=t.fn||P;this._runs=[]}l.inherits(Task,O);Task.prototype.setupRun=function(t){var r=this;var n=new z(this._runs.length);this._runs.push(n);n.start();this.emit("starting",this,n);return function finishRun(e){n.end();if(e){B.define(e,"task",r);B.define(e,"run",n);r.emit("error",e)}else r.emit("finished",r,n);return t.apply(null,arguments)}};Task.prototype.runDeps=function(t){if(!this.deps.length)return t();var r=A(this.options.flow||"series");var n=r.call(this.app,this.deps);return n(t)};Task.prototype.run=function(t){if(skip(this))return t();var r=this;var n=this.setupRun(t);this.runDeps((function(e){if(e)return t(e);var i;try{var o=r.fn;i=B.isGenerator.fn(o)?B.co(o,n):o.call(r,n)}catch(e){return n(e)}if("undefined"!==typeof i){if("function"===typeof i.on){i.on("error",n);i.on("end",n);i.resume();return}if("function"===typeof i.then){i.then((function(t){return n(null,t)}),n);return}}}))};function skip(t){if("undefined"===typeof t.options.run&&"undefined"===typeof t.options.skip)return false;if("boolean"===typeof t.options.run)return false===t.options.run;var r=B.arrayify(t.options.skip);return~r.indexOf(t.name)}G=Task;var H=G;var I={};var K=0;I=function(t){if("function"===typeof t){var r=t.taskName||t.name||"[anonymous ("+ ++K+")]";this.task(r,t);return r}return t};var N=I;var J={};J=function inspect(t,r){t.options&&false===t.options.inspectFn||(t.options&&"function"===typeof t.options.inspectFn?r.inspect=function(){return t.options.inspectFn.call(t,r)}:r.inspect=function(){var t="["+r.options.deps.join(", ")+"]";return'<Task "'+r.name+'" deps: '+t+">"})};var L=J;var M={};var Q=w;var S=H;var U=D;var V=y;var W=N;var X=L;var Y=_;var Z=c;var $=[];function Composer(t){Z.call(this);this.tasks={};V.define(this,"_appname",t||this._appname||"composer");V.define(this,"buildHistory",{configurable:true,get:function(){return $}})}Z(Composer.prototype);Composer.prototype.task=function(t){if("string"!==typeof t)throw new TypeError("expected `name` to be a string");var r=[].concat.apply([],[].slice.call(arguments,1));var n={};var e=U;r.length&&"function"===typeof r[r.length-1]&&(e=r.pop());r.length&&V.isobject(r[0])&&(n=r.shift());n.deps=V.unique(r.concat(n.deps||[]).map(W.bind(this)));var i=new S({name:t,options:n,fn:e,app:this});X(this,i);i.on("starting",this.emit.bind(this,"task:starting"));i.on("finished",this.emit.bind(this,"task:finished"));i.on("error",this.emit.bind(this,"task:error"));this.tasks[t]=i;this.emit("task",this.name,i);return this};Composer.prototype.build=function(){var t=[].concat.apply([],[].slice.call(arguments));var r=t.pop();if("function"!==typeof r)throw new TypeError("Expected the last argument to be a callback function, but got `"+typeof r+"`.");var n={};t.length&&V.isobject(t[t.length-1])&&(n=t.pop());0===t.length&&(t=["default"]);t.push(n);var e=this;var i=new Q($.length);$.push(i);i.start();this.emit("starting",this,i);function finishBuild(t){i.end();if(t){V.define(t,"app",e);V.define(t,"build",i);e.emit("error",t)}else e.emit("finished",e,i);return r.apply(null,arguments)}var o=this.series.apply(this,t);return o(finishBuild)};Composer.prototype.series=Y("series");Composer.prototype.parallel=Y("parallel");M=Composer;var tt=M;export default tt;

